<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConnectNow - Video Calls</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Custom animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes pulse-ring {
            0% { transform: scale(0.8); }
            80%, 100% { transform: scale(1.2); opacity: 0; }
        }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        .slide-up { animation: slideUp 0.3s ease-out; }
        .pulse-ring { animation: pulse-ring 2s infinite; }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- Main App Container -->
    <div id="app" class="max-w-md mx-auto min-h-screen relative overflow-hidden">
        <!-- User List Screen -->
        <div id="userListScreen" class="min-h-screen p-4 fade-in">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold text-purple-500">ConnectNow</h1>
                <button id="logoutBtn" class="bg-gray-800 hover:bg-gray-700 text-white px-4 py-2 rounded-full transition-all">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </button>
            </div>
            
            <div class="mb-6">
                <h2 class="text-xl font-semibold mb-4">Contacts</h2>
                <div id="usersList" class="space-y-3">
                    <!-- Users will be dynamically loaded here -->
                    <div class="flex justify-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-purple-500"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calling Screen -->
        <div id="callingScreen" class="hidden fixed inset-0 bg-gray-900 z-50 flex flex-col items-center justify-center p-6">
            <div class="text-center slide-up">
                <div class="relative mx-auto w-32 h-32 mb-6">
                    <div class="absolute inset-0 rounded-full bg-purple-500 opacity-20 pulse-ring"></div>
                    <img id="callingAvatar" src="" class="w-32 h-32 rounded-full object-cover border-4 border-purple-500" alt="Calling user">
                </div>
                <h2 id="callingName" class="text-2xl font-bold mb-2">Calling...</h2>
                <p class="text-gray-400 mb-8">Waiting for response</p>
                <button id="cancelCallBtn" class="bg-red-500 hover:bg-red-600 text-white px-8 py-3 rounded-full transition-all">
                    <i class="fas fa-times mr-2"></i>Cancel Call
                </button>
            </div>
        </div>

        <!-- Incoming Call Screen -->
        <div id="incomingCallScreen" class="hidden fixed inset-0 bg-gray-900 z-50 flex flex-col items-center justify-center p-6">
            <div class="text-center slide-up">
                <div class="relative mx-auto w-32 h-32 mb-6">
                    <div class="absolute inset-0 rounded-full bg-purple-500 opacity-20 pulse-ring"></div>
                    <img id="incomingCallAvatar" src="" class="w-32 h-32 rounded-full object-cover border-4 border-purple-500" alt="Caller">
                </div>
                <h2 id="incomingCallName" class="text-2xl font-bold mb-2">Incoming Call</h2>
                <p class="text-gray-400 mb-8">is calling you...</p>
                <div class="flex space-x-4">
                    <button id="declineCallBtn" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-full transition-all">
                        <i class="fas fa-times mr-2"></i>Decline
                    </button>
                    <button id="acceptCallBtn" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-full transition-all">
                        <i class="fas fa-phone mr-2"></i>Accept
                    </button>
                </div>
            </div>
            <audio id="ringtone" loop>
                <source src="https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg" type="audio/ogg">
            </audio>
        </div>

        <!-- Video Call Screen -->
        <div id="videoCallScreen" class="hidden fixed inset-0 bg-black z-50">
            <!-- Remote Video -->
            <video id="remoteVideo" autoplay playsinline class="w-full h-full object-cover"></video>
            
            <!-- Local Video Preview -->
            <div class="absolute top-4 right-4 w-32 h-48 rounded-lg overflow-hidden border-2 border-white shadow-lg">
                <video id="localVideo" autoplay playsinline muted class="w-full h-full object-cover"></video>
            </div>
            
            <!-- Call Controls -->
            <div class="absolute bottom-6 left-0 right-0 flex justify-center space-x-6">
                <button id="muteBtn" class="bg-gray-700 hover:bg-gray-600 text-white w-14 h-14 rounded-full flex items-center justify-center transition-all">
                    <i class="fas fa-microphone text-xl"></i>
                </button>
                <button id="endCallBtn" class="bg-red-500 hover:bg-red-600 text-white w-16 h-16 rounded-full flex items-center justify-center transition-all">
                    <i class="fas fa-phone-slash text-xl"></i>
                </button>
                <button id="switchCameraBtn" class="bg-gray-700 hover:bg-gray-600 text-white w-14 h-14 rounded-full flex items-center justify-center transition-all">
                    <i class="fas fa-camera-rotate text-xl"></i>
                </button>
            </div>
            
            <!-- Call Info -->
            <div class="absolute top-4 left-4 bg-black bg-opacity-50 px-4 py-2 rounded-lg">
                <h3 id="callPartnerName" class="font-semibold"></h3>
                <p id="callDuration" class="text-sm text-gray-300">00:00</p>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAwB8JWKIRK6Bkat-NdM6OyVAvdrBk5cmM",
            authDomain: "capturedeep-126bf.firebaseapp.com",
            databaseURL: "https://capturedeep-126bf-default-rtdb.firebaseio.com",
            projectId: "capturedeep-126bf",
            storageBucket: "capturedeep-126bf.appspot.com",
            messagingSenderId: "527347157327",
            appId: "1:527347157327:web:d7db7bb6d0fe021547dd3a",
            measurementId: "G-VZEFR8X5BN"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const rtdb = firebase.database();

        // Global Variables
        let currentUser = null;
        let users = [];
        let localStream = null;
        let remoteStream = null;
        let peerConnection = null;
        let callRequestRef = null;
        let callDurationInterval = null;
        let callStartTime = null;
        let isMuted = false;
        let isCallActive = false;

        // WebRTC Configuration
        const pcConfig = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' }
            ]
        };

        // DOM Elements
        const userListScreen = document.getElementById('userListScreen');
        const callingScreen = document.getElementById('callingScreen');
        const incomingCallScreen = document.getElementById('incomingCallScreen');
        const videoCallScreen = document.getElementById('videoCallScreen');
        const usersList = document.getElementById('usersList');
        const logoutBtn = document.getElementById('logoutBtn');
        const cancelCallBtn = document.getElementById('cancelCallBtn');
        const declineCallBtn = document.getElementById('declineCallBtn');
        const acceptCallBtn = document.getElementById('acceptCallBtn');
        const endCallBtn = document.getElementById('endCallBtn');
        const muteBtn = document.getElementById('muteBtn');
        const switchCameraBtn = document.getElementById('switchCameraBtn');
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const ringtone = document.getElementById('ringtone');
        const callPartnerName = document.getElementById('callPartnerName');
        const callDuration = document.getElementById('callDuration');

        // Authentication State Listener
        auth.onAuthStateChanged((user) => {
            if (user) {
                // User is signed in
                currentUser = user;
                setupUserPresence();
                loadUsers();
                setupCallListener();
            } else {
                // User is signed out, redirect to auth page
                window.location.href = 'auth.html';
            }
        });

        // Setup user online status in Realtime Database
        function setupUserPresence() {
            const userStatusRef = rtdb.ref('status/' + currentUser.uid);
            
            // Set user as online
            userStatusRef.set({
                online: true,
                lastSeen: null
            });
            
            // Handle disconnect
            userStatusRef.onDisconnect().set({
                online: false,
                lastSeen: firebase.database.ServerValue.TIMESTAMP
            });
        }

        // Load all users from Firestore (excluding current user)
        async function loadUsers() {
            try {
                const snapshot = await db.collection('users').get();
                users = [];
                
                snapshot.forEach(doc => {
                    if (doc.id !== currentUser.uid) {
                        users.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    }
                });
                
                renderUsers();
                setupUserStatusListener();
            } catch (error) {
                console.error('Error loading users:', error);
                usersList.innerHTML = '<p class="text-center text-red-500">Error loading users</p>';
            }
        }

        // Render users list
        function renderUsers() {
            usersList.innerHTML = '';
            
            if (users.length === 0) {
                usersList.innerHTML = '<p class="text-center text-gray-500">No users found</p>';
                return;
            }
            
            users.forEach(user => {
                const userElement = document.createElement('div');
                userElement.className = 'flex items-center p-3 bg-gray-800 rounded-xl hover:bg-gray-700 transition-all cursor-pointer';
                userElement.innerHTML = `
                    <div class="relative mr-4">
                        <img src="${user.avatarUrl || 'https://via.placeholder.com/50'}" 
                             class="w-12 h-12 rounded-full object-cover" alt="${user.name}">
                        <div class="absolute -bottom-1 -right-1 w-4 h-4 rounded-full border-2 border-gray-800 ${user.online ? 'bg-green-500' : 'bg-gray-500'}"></div>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-semibold">${user.name}</h3>
                        <p class="text-sm text-gray-400">${user.online ? 'Online' : formatLastSeen(user.lastSeen)}</p>
                    </div>
                    <button class="video-call-btn p-3 bg-purple-600 hover:bg-purple-700 rounded-full transition-all" data-userid="${user.id}">
                        <i class="fas fa-video text-white"></i>
                    </button>
                `;
                usersList.appendChild(userElement);
            });
            
            // Add event listeners to call buttons
            document.querySelectorAll('.video-call-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const userId = btn.getAttribute('data-userid');
                    const user = users.find(u => u.id === userId);
                    initiateCall(user);
                });
            });
        }

        // Setup real-time user status listener
        function setupUserStatusListener() {
            users.forEach(user => {
                const userStatusRef = rtdb.ref('status/' + user.id);
                userStatusRef.on('value', (snapshot) => {
                    const status = snapshot.val();
                    if (status) {
                        user.online = status.online;
                        user.lastSeen = status.lastSeen;
                        
                        // Update UI for this user
                        const userElement = document.querySelector(`[data-userid="${user.id}"]`).closest('.flex');
                        if (userElement) {
                            const statusElement = userElement.querySelector('.text-sm');
                            if (statusElement) {
                                statusElement.textContent = user.online ? 'Online' : formatLastSeen(user.lastSeen);
                            }
                            
                            const statusDot = userElement.querySelector('.absolute .rounded-full');
                            if (statusDot) {
                                statusDot.className = `absolute -bottom-1 -right-1 w-4 h-4 rounded-full border-2 border-gray-800 ${user.online ? 'bg-green-500' : 'bg-gray-500'}`;
                            }
                        }
                    }
                });
            });
        }

        // Format last seen timestamp
        function formatLastSeen(timestamp) {
            if (!timestamp) return 'Offline';
            
            const now = Date.now();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (days > 0) return `${days}d ago`;
            if (hours > 0) return `${hours}h ago`;
            if (minutes > 0) return `${minutes}m ago`;
            return 'Just now';
        }

        // Setup call listener for incoming calls
        function setupCallListener() {
            const callRef = rtdb.ref('calls/' + currentUser.uid);
            
            callRef.on('value', (snapshot) => {
                const callData = snapshot.val();
                
                if (callData && callData.type === 'offer' && !isCallActive) {
                    showIncomingCall(callData);
                }
            });
        }

        // Show incoming call screen
        function showIncomingCall(callData) {
            const caller = users.find(u => u.id === callData.from);
            if (!caller) return;
            
            document.getElementById('incomingCallAvatar').src = caller.avatarUrl || 'https://via.placeholder.com/128';
            document.getElementById('incomingCallName').textContent = caller.name;
            
            incomingCallScreen.classList.remove('hidden');
            ringtone.play().catch(e => console.error('Error playing ringtone:', e));
            
            // Store reference to call request
            callRequestRef = rtdb.ref('calls/' + currentUser.uid);
        }

        // Initiate a call to another user
        async function initiateCall(user) {
            if (!user.online) {
                alert(`${user.name} is offline. Try again later.`);
                return;
            }
            
            try {
                // Show calling screen
                document.getElementById('callingAvatar').src = user.avatarUrl || 'https://via.placeholder.com/128';
                document.getElementById('callingName').textContent = `Calling ${user.name}`;
                callingScreen.classList.remove('hidden');
                
                // Initialize WebRTC
                await initializeWebRTC();
                
                // Create offer
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                // Send offer to recipient
                await rtdb.ref('calls/' + user.id).set({
                    type: 'offer',
                    from: currentUser.uid,
                    offer: offer
                });
                
                // Listen for answer
                listenForAnswer(user.id);
                
            } catch (error) {
                console.error('Error initiating call:', error);
                alert('Failed to start call. Please try again.');
                hideCallingScreen();
            }
        }

        // Initialize WebRTC
        async function initializeWebRTC() {
            try {
                // Get local media stream
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: true, 
                    audio: true 
                });
                
                // Create peer connection
                peerConnection = new RTCPeerConnection(pcConfig);
                
                // Add local stream to connection
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                // Set up local video
                localVideo.srcObject = localStream;
                
                // Handle remote stream
                peerConnection.ontrack = (event) => {
                    remoteStream = event.streams[0];
                    remoteVideo.srcObject = remoteStream;
                };
                
                // Handle ICE candidates
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        // Send ICE candidate to the other peer
                        rtdb.ref('candidates/' + currentUser.uid).push({
                            candidate: event.candidate,
                            from: currentUser.uid
                        });
                    }
                };
                
                // Listen for ICE candidates from the other peer
                listenForCandidates();
                
            } catch (error) {
                console.error('Error initializing WebRTC:', error);
                throw error;
            }
        }

        // Listen for answer from the other user
        function listenForAnswer(userId) {
            const answerRef = rtdb.ref('calls/' + currentUser.uid);
            
            answerRef.on('value', (snapshot) => {
                const data = snapshot.val();
                
                if (data && data.type === 'answer' && data.from === userId) {
                    // Set remote description
                    peerConnection.setRemoteDescription(data.answer)
                        .then(() => {
                            hideCallingScreen();
                            startVideoCall();
                        })
                        .catch(error => {
                            console.error('Error setting remote description:', error);
                            hideCallingScreen();
                        });
                    
                    // Stop listening for answer
                    answerRef.off();
                }
            });
        }

        // Listen for ICE candidates
        function listenForCandidates() {
            const candidatesRef = rtdb.ref('candidates/' + currentUser.uid);
            
            candidatesRef.on('child_added', (snapshot) => {
                const candidateData = snapshot.val();
                peerConnection.addIceCandidate(new RTCIceCandidate(candidateData.candidate))
                    .catch(error => console.error('Error adding ICE candidate:', error));
                
                // Remove candidate after processing
                snapshot.ref.remove();
            });
        }

        // Start video call
        function startVideoCall() {
            videoCallScreen.classList.remove('hidden');
            isCallActive = true;
            callStartTime = Date.now();
            
            // Start call duration timer
            callDurationInterval = setInterval(updateCallDuration, 1000);
            
            // Set call partner name
            const callPartner = users.find(u => 
                u.id === (callRequestRef ? callRequestRef.key.replace('calls/', '') : '')
            );
            if (callPartner) {
                callPartnerName.textContent = callPartner.name;
            }
        }

        // Update call duration
        function updateCallDuration() {
            if (!callStartTime) return;
            
            const now = Date.now();
            const duration = Math.floor((now - callStartTime) / 1000);
            const minutes = Math.floor(duration / 60);
            const seconds = duration % 60;
            
            callDuration.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Hide calling screen
        function hideCallingScreen() {
            callingScreen.classList.add('hidden');
        }

        // End call and cleanup
        function endCall() {
            // Stop media tracks
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            
            // Close peer connection
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            // Clear intervals
            if (callDurationInterval) {
                clearInterval(callDurationInterval);
                callDurationInterval = null;
            }
            
            // Stop ringtone
            ringtone.pause();
            ringtone.currentTime = 0;
            
            // Hide all call screens
            callingScreen.classList.add('hidden');
            incomingCallScreen.classList.add('hidden');
            videoCallScreen.classList.add('hidden');
            
            // Reset call state
            isCallActive = false;
            callStartTime = null;
            
            // Clear call data from database
            if (callRequestRef) {
                callRequestRef.remove();
                callRequestRef = null;
            }
            
            // Clear candidates
            rtdb.ref('candidates/' + currentUser.uid).remove();
        }

        // Toggle mute
        function toggleMute() {
            if (!localStream) return;
            
            const audioTracks = localStream.getAudioTracks();
            if (audioTracks.length > 0) {
                isMuted = !isMuted;
                audioTracks[0].enabled = !isMuted;
                
                // Update button icon
                const icon = muteBtn.querySelector('i');
                if (isMuted) {
                    icon.className = 'fas fa-microphone-slash text-xl';
                    muteBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                } else {
                    icon.className = 'fas fa-microphone text-xl';
                    muteBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                }
            }
        }

        // Switch camera
        async function switchCamera() {
            if (!localStream) return;
            
            try {
                // Get all video tracks
                const videoTracks = localStream.getVideoTracks();
                if (videoTracks.length === 0) return;
                
                // Stop current video track
                videoTracks[0].stop();
                
                // Get new media stream with opposite facing mode
                const currentConstraints = videoTracks[0].getConstraints();
                const newConstraints = {
                    video: {
                        facingMode: currentConstraints.facingMode === 'user' ? 'environment' : 'user'
                    },
                    audio: true
                };
                
                // Get new stream
                const newStream = await navigator.mediaDevices.getUserMedia(newConstraints);
                
                // Replace the video track in the local stream
                const newVideoTrack = newStream.getVideoTracks()[0];
                const sender = peerConnection.getSenders().find(s => 
                    s.track && s.track.kind === 'video'
                );
                
                if (sender) {
                    await sender.replaceTrack(newVideoTrack);
                }
                
                // Update local video
                localStream.removeTrack(videoTracks[0]);
                localStream.addTrack(newVideoTrack);
                localVideo.srcObject = localStream;
                
            } catch (error) {
                console.error('Error switching camera:', error);
            }
        }

        // Event Listeners
        logoutBtn.addEventListener('click', () => {
            auth.signOut().then(() => {
                window.location.href = 'auth.html';
            });
        });
        
        cancelCallBtn.addEventListener('click', () => {
            endCall();
        });
        
        declineCallBtn.addEventListener('click', () => {
            endCall();
        });
        
        acceptCallBtn.addEventListener('click', async () => {
            try {
                // Stop ringtone
                ringtone.pause();
                ringtone.currentTime = 0;
                
                // Initialize WebRTC
                await initializeWebRTC();
                
                // Get call data
                const callData = (await callRequestRef.once('value')).val();
                if (!callData) return;
                
                // Set remote description
                await peerConnection.setRemoteDescription(callData.offer);
                
                // Create answer
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                
                // Send answer to caller
                await rtdb.ref('calls/' + callData.from).set({
                    type: 'answer',
                    from: currentUser.uid,
                    answer: answer
                });
                
                // Hide incoming call screen and start video call
                incomingCallScreen.classList.add('hidden');
                startVideoCall();
                
            } catch (error) {
                console.error('Error accepting call:', error);
                alert('Failed to accept call. Please try again.');
                endCall();
            }
        });
        
        endCallBtn.addEventListener('click', () => {
            endCall();
        });
        
        muteBtn.addEventListener('click', () => {
            toggleMute();
        });
        
        switchCameraBtn.addEventListener('click', () => {
            switchCamera();
        });
    </script>
</body>
</html>
