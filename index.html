<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ConnectNow - Fixed Video Call</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--bg:#0b0f13;--card:#161e2a;--text:#e6eef8;--accent:#3b82f6}
    body{background:var(--bg);color:var(--text);font-family:Inter,system-ui,sans-serif}
    .video-card{background:#000;border-radius:12px;overflow:hidden;position:relative;box-shadow:0 10px 30px rgba(0,0,0,0.5)}
    .local-pip{position:absolute;bottom:16px;right:16px;width:120px;height:160px;background:#222;border-radius:8px;border:2px solid rgba(255,255,255,0.1);box-shadow:0 4px 12px rgba(0,0,0,0.5);z-index:20}
    .local-pip video{width:100%;height:100%;object-fit:cover;border-radius:6px}
    /* Pulse animation for calling */
    @keyframes pulse-ring{0%{transform:scale(0.8);opacity:0.5}100%{transform:scale(1.2);opacity:0}}
    .pulse-avatar::before{content:'';position:absolute;left:0;top:0;width:100%;height:100%;border-radius:50%;border:2px solid var(--accent);animation:pulse-ring 2s infinite}
  </style>
</head>
<body class="min-h-screen flex flex-col">

  <nav class="bg-gray-900 border-b border-gray-800 p-4">
    <div class="max-w-5xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div id="myAvatarDisplay" class="w-10 h-10 rounded-full bg-gray-700 bg-cover bg-center"></div>
        <div>
          <h1 class="font-bold text-lg tracking-tight">ConnectNow</h1>
          <p id="connectionStatus" class="text-xs text-green-400">Online</p>
        </div>
      </div>
      <button id="logoutBtn" class="text-sm bg-red-500/10 text-red-400 px-3 py-1.5 rounded hover:bg-red-500/20 transition hidden">Sign Out</button>
    </div>
  </nav>

  <main class="flex-1 max-w-5xl mx-auto w-full p-4 grid grid-cols-1 md:grid-cols-12 gap-6">
    
    <aside class="md:col-span-4 lg:col-span-3 flex flex-col gap-4 max-h-[80vh]">
      <div class="bg-gray-900 p-4 rounded-xl border border-gray-800 flex-1 overflow-hidden flex flex-col">
        <h2 class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-4">Active Users</h2>
        <div id="usersContainer" class="space-y-2 overflow-y-auto flex-1 pr-2">
          <div class="text-gray-500 text-sm text-center mt-10">Loading users...</div>
        </div>
      </div>
    </aside>

    <section class="md:col-span-8 lg:col-span-9 relative">
      
      <div id="idleScreen" class="h-[500px] bg-gray-900 rounded-2xl border border-gray-800 flex flex-col items-center justify-center text-center p-6">
        <div class="w-24 h-24 bg-gray-800 rounded-full flex items-center justify-center mb-4 text-4xl">ðŸ‘‹</div>
        <h3 class="text-xl font-medium mb-2">Ready to connect</h3>
        <p class="text-gray-400 max-w-sm">Select a user from the list to start a video call. Ensure you allow camera and microphone permissions.</p>
      </div>

      <div id="outgoingScreen" class="hidden h-[500px] bg-gray-900 rounded-2xl border border-gray-800 flex-col items-center justify-center text-center p-6 relative">
        <div class="pulse-avatar relative w-32 h-32 rounded-full mb-6 mx-auto">
          <img id="outgoingAvatar" class="w-full h-full rounded-full object-cover bg-gray-700">
        </div>
        <h3 class="text-2xl font-bold mb-1" id="outgoingName">User</h3>
        <p class="text-blue-400 animate-pulse mb-8">Calling...</p>
        <button id="cancelCallBtn" class="bg-red-600 hover:bg-red-700 text-white px-8 py-3 rounded-full font-medium transition shadow-lg shadow-red-900/20">End Call</button>
      </div>

      <div id="activeScreen" class="hidden h-[500px] md:h-[600px] video-card">
        <video id="remoteVideo" autoplay playsinline class="w-full h-full object-cover bg-gray-900"></video>
        
        <div class="local-pip">
          <video id="localVideo" autoplay muted playsinline class="bg-gray-800"></video>
        </div>

        <div class="absolute bottom-6 left-0 w-full flex justify-center gap-4 z-30">
          <button id="toggleAudioBtn" class="bg-gray-700 hover:bg-gray-600 p-4 rounded-full text-white transition backdrop-blur-md bg-opacity-80">
            ðŸŽ¤
          </button>
          <button id="hangupBtn" class="bg-red-600 hover:bg-red-700 p-4 rounded-full text-white transition shadow-lg shadow-red-900/50">
            ðŸ“ž
          </button>
        </div>
        
        <div class="absolute top-4 left-4 bg-black/60 backdrop-blur px-3 py-1.5 rounded-lg text-sm font-medium z-20">
          <span class="w-2 h-2 bg-green-500 rounded-full inline-block mr-2"></span>
          <span id="remoteNameTag">Connected</span>
        </div>
      </div>

    </section>
  </main>

  <div id="incomingModal" class="fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-gray-900 border border-gray-700 p-8 rounded-2xl max-w-sm w-full text-center shadow-2xl">
      <img id="incomingAvatarImg" class="w-24 h-24 rounded-full mx-auto mb-4 object-cover bg-gray-800 border-4 border-gray-800">
      <h3 id="incomingCallerName" class="text-2xl font-bold mb-1 text-white">Unknown</h3>
      <p class="text-gray-400 mb-8">Incoming video call...</p>
      <div class="flex gap-4 justify-center">
        <button id="declineBtn" class="bg-red-600 text-white px-6 py-3 rounded-xl font-medium hover:bg-red-700 transition w-full">Decline</button>
        <button id="acceptBtn" class="bg-green-600 text-white px-6 py-3 rounded-xl font-medium hover:bg-green-700 transition w-full">Accept</button>
      </div>
    </div>
  </div>

  <audio id="ringtoneSound" loop src="https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg"></audio>

  <script type="module">
    // -------------------------------------------------------------
    // 1. FIREBASE CONFIGURATION
    // -------------------------------------------------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
    import { getDatabase, ref, set, onValue, push, onChildAdded, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAwB8JWKIRK6Bkat-NdM6OyVAvdrBk5cmM", // Make sure this is valid
      authDomain: "capturedeep-126bf.firebaseapp.com",
      databaseURL: "https://capturedeep-126bf-default-rtdb.firebaseio.com",
      projectId: "capturedeep-126bf",
      storageBucket: "capturedeep-126bf.appspot.com",
      messagingSenderId: "527347157327",
      appId: "1:527347157327:web:d7db7bb6d0fe021547dd3a"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const rdb = getDatabase(app);

    // -------------------------------------------------------------
    // 2. STATE & DOM ELEMENTS
    // -------------------------------------------------------------
    let myUid = null;
    let myProfile = {};
    let localStream = null;
    let peerConnection = null;
    let currentCallNodeId = null; // The User ID of the person we are talking to
    let iceCandidateQueue = [];   // BUFFER: Stores candidates until connection is ready
    let isMuted = false;

    // Google STUN servers are reliable. For Production, you NEED a TURN server.
    const rtcConfig = {
      iceServers: [
        { urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }
      ]
    };

    // DOM Elements
    const views = {
      idle: document.getElementById('idleScreen'),
      outgoing: document.getElementById('outgoingScreen'),
      active: document.getElementById('activeScreen'),
      incoming: document.getElementById('incomingModal')
    };

    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const ringtone = document.getElementById('ringtoneSound');

    // -------------------------------------------------------------
    // 3. AUTH & USER PRESENCE
    // -------------------------------------------------------------
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        myUid = user.uid;
        document.getElementById('logoutBtn').classList.remove('hidden');
        
        // Save/Update Profile
        myProfile = {
          name: user.displayName || 'User',
          photoURL: user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName}`,
          email: user.email
        };
        
        // Update UI
        document.getElementById('myAvatarDisplay').style.backgroundImage = `url(${myProfile.photoURL})`;
        
        // Write to Firestore (so we appear in list)
        await setDoc(doc(db, 'users', myUid), myProfile, { merge: true });
        
        // Write Presence to Realtime DB
        const presenceRef = ref(rdb, `presence/${myUid}`);
        set(presenceRef, { online: true, lastSeen: Date.now() });
        onDisconnect(presenceRef).remove();

        // Listeners
        listenToUsers();
        listenToIncomingCalls();
        listenToICECandidates();
      } else {
        // Simple Login Trigger if not logged in
        const provider = new GoogleAuthProvider();
        try {
          await signInWithPopup(auth, provider);
        } catch (e) {
          alert("Login failed: " + e.message);
        }
      }
    });

    document.getElementById('logoutBtn').onclick = () => signOut(auth);

    function listenToUsers() {
      const container = document.getElementById('usersContainer');
      onSnapshot(collection(db, 'users'), (snapshot) => {
        container.innerHTML = '';
        if (snapshot.empty) container.innerHTML = '<div class="text-gray-500 p-4">No other users found.</div>';
        
        snapshot.forEach(docSnap => {
          const uData = docSnap.data();
          const uid = docSnap.id;
          if (uid === myUid) return; // Don't show self

          const div = document.createElement('div');
          div.className = 'flex items-center justify-between bg-gray-800 p-3 rounded-lg hover:bg-gray-750 transition border border-gray-700/50';
          div.innerHTML = `
            <div class="flex items-center gap-3">
              <img src="${uData.photoURL}" class="w-10 h-10 rounded-full object-cover">
              <div class="text-sm font-medium text-white">${uData.name}</div>
            </div>
            <button class="bg-blue-600 hover:bg-blue-500 text-white p-2 rounded-full transition call-btn">
              ðŸ“¹
            </button>
          `;
          
          div.querySelector('.call-btn').onclick = () => startOutgoingCall(uid, uData);
          container.appendChild(div);
        });
      });
    }

    // -------------------------------------------------------------
    // 4. WEBRTC CORE LOGIC (The Fix)
    // -------------------------------------------------------------

    async function initializeMedia() {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localVideo.srcObject = localStream;
        return true;
      } catch (err) {
        console.error("Media Error:", err);
        alert("Could not access camera/mic. Please check permissions.");
        return false;
      }
    }

    function createPeerConnection(targetUid) {
      peerConnection = new RTCPeerConnection(rtcConfig);

      // 1. Add Local Tracks
      localStream.getTracks().forEach(track => {
        peerConnection.addTrack(track, localStream);
      });

      // 2. Handle Remote Tracks (Video appears here)
      peerConnection.ontrack = (event) => {
        if (remoteVideo.srcObject !== event.streams[0]) {
          remoteVideo.srcObject = event.streams[0];
          console.log("Remote stream received!");
        }
      };

      // 3. Handle ICE Candidates (Network details)
      peerConnection.onicecandidate = (event) => {
        if (event.candidate) {
          // Send to Firebase under the TARGET's ID
          const path = `candidates/${targetUid}`;
          push(ref(rdb, path), {
            candidate: event.candidate.toJSON(),
            from: myUid
          });
        }
      };
      
      // 4. Connection State Logging
      peerConnection.onconnectionstatechange = () => {
        console.log("Connection State:", peerConnection.connectionState);
        if(peerConnection.connectionState === 'disconnected') endCall();
      };

      return peerConnection;
    }

    // THE FIX: Strict Queue Processing
    async function addBufferedCandidates() {
      if (!peerConnection || !peerConnection.remoteDescription) return;
      
      console.log(`Flushing ${iceCandidateQueue.length} candidates...`);
      while (iceCandidateQueue.length > 0) {
        const candidate = iceCandidateQueue.shift();
        try {
          await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
        } catch (e) {
          console.warn("Candidate fail:", e);
        }
      }
    }

    // -------------------------------------------------------------
    // 5. CALLING FLOW (Caller)
    // -------------------------------------------------------------
    async function startOutgoingCall(targetUid, targetProfile) {
      currentCallNodeId = targetUid;
      
      // UI Updates
      views.idle.classList.add('hidden');
      views.outgoing.classList.remove('hidden');
      views.outgoing.style.display = 'flex';
      document.getElementById('outgoingName').textContent = targetProfile.name;
      document.getElementById('outgoingAvatar').src = targetProfile.photoURL;
      
      const hasMedia = await initializeMedia();
      if (!hasMedia) return endCall();

      createPeerConnection(targetUid);

      // Create Offer
      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);

      // Send Offer to Firebase
      await set(ref(rdb, `calls/${targetUid}`), {
        type: 'offer',
        sdp: offer.sdp,
        from: myUid,
        callerName: myProfile.name,
        callerPhoto: myProfile.photoURL
      });

      // Listen for Answer
      const answerRef = ref(rdb, `calls/${myUid}`);
      onValue(answerRef, async (snapshot) => {
        const data = snapshot.val();
        if (!peerConnection || !data) return;

        if (data.type === 'answer' && peerConnection.signalingState === 'have-local-offer') {
          // Set Remote Description
          const rsd = new RTCSessionDescription({ type: 'answer', sdp: data.sdp });
          await peerConnection.setRemoteDescription(rsd);
          
          // NOW it is safe to add queued candidates
          addBufferedCandidates();

          // Switch to Active View
          views.outgoing.classList.add('hidden');
          views.active.classList.remove('hidden');
          views.active.style.display = 'block';
          document.getElementById('remoteNameTag').textContent = targetProfile.name;
        } 
        else if (data.type === 'reject') {
          alert("Call declined");
          endCall();
        }
      });
    }

    // -------------------------------------------------------------
    // 6. INCOMING FLOW (Callee)
    // -------------------------------------------------------------
    function listenToIncomingCalls() {
      const myCallRef = ref(rdb, `calls/${myUid}`);
      onValue(myCallRef, (snapshot) => {
        const data = snapshot.val();
        if (data && data.type === 'offer') {
          // Show Modal
          currentCallNodeId = data.from;
          document.getElementById('incomingCallerName').textContent = data.callerName;
          document.getElementById('incomingAvatarImg').src = data.callerPhoto;
          views.incoming.classList.remove('hidden');
          views.incoming.style.display = 'flex';
          
          // Play Ringtone
          ringtone.currentTime = 0;
          ringtone.play().catch(e => console.log("Autoplay blocked"));

          // Handle Accept
          document.getElementById('acceptBtn').onclick = () => acceptCall(data);
          
          // Handle Decline
          document.getElementById('declineBtn').onclick = () => {
            set(ref(rdb, `calls/${data.from}`), { type: 'reject' }); // Tell caller
            set(ref(rdb, `calls/${myUid}`), null); // Clear my node
            views.incoming.classList.add('hidden');
            ringtone.pause();
          };
        }
      });
    }

    async function acceptCall(data) {
      ringtone.pause();
      views.incoming.classList.add('hidden');
      views.idle.classList.add('hidden');
      views.active.classList.remove('hidden');
      views.active.style.display = 'block';
      document.getElementById('remoteNameTag').textContent = data.callerName;

      const hasMedia = await initializeMedia();
      if (!hasMedia) return;

      createPeerConnection(currentCallNodeId);

      // Set Remote Description (The Offer)
      const rsd = new RTCSessionDescription({ type: 'offer', sdp: data.sdp });
      await peerConnection.setRemoteDescription(rsd);
      
      // Process any candidates that arrived while we were clicking "Accept"
      addBufferedCandidates();

      // Create Answer
      const answer = await peerConnection.createAnswer();
      await peerConnection.setLocalDescription(answer);

      // Send Answer back to Caller
      await set(ref(rdb, `calls/${data.from}`), {
        type: 'answer',
        sdp: answer.sdp,
        from: myUid
      });
    }

    // -------------------------------------------------------------
    // 7. CANDIDATE LISTENER (The Key to Connectivity)
    // -------------------------------------------------------------
    function listenToICECandidates() {
      // We listen to candidates sent TO us
      const myCandidatesRef = ref(rdb, `candidates/${myUid}`);
      onChildAdded(myCandidatesRef, (snapshot) => {
        const val = snapshot.val();
        if (!val || !val.candidate) return;

        // CRITICAL FIX:
        // If PC doesn't exist OR Remote Description isn't set yet, QUEUE IT.
        if (!peerConnection || !peerConnection.remoteDescription) {
          iceCandidateQueue.push(val.candidate);
        } else {
          peerConnection.addIceCandidate(new RTCIceCandidate(val.candidate))
            .catch(e => console.error("AddIce Error", e));
        }
      });
    }

    // -------------------------------------------------------------
    // 8. UTILITIES
    // -------------------------------------------------------------
    function endCall() {
      // Cleanup WebRTC
      if (peerConnection) {
        peerConnection.close();
        peerConnection = null;
      }
      if (localStream) {
        localStream.getTracks().forEach(t => t.stop());
        localStream = null;
      }
      
      // Cleanup UI
      views.idle.classList.remove('hidden');
      views.outgoing.classList.add('hidden');
      views.active.classList.add('hidden');
      views.incoming.classList.add('hidden');
      
      // Cleanup DB
      if (currentCallNodeId) {
        // Clear candidates
        set(ref(rdb, `candidates/${currentCallNodeId}`), null);
        set(ref(rdb, `candidates/${myUid}`), null);
        // Clear signals
        set(ref(rdb, `calls/${currentCallNodeId}`), null);
        set(ref(rdb, `calls/${myUid}`), null);
      }
      
      iceCandidateQueue = [];
      currentCallNodeId = null;
      ringtone.pause();
      window.location.reload(); // Hard reset for cleanliness in single-file app
    }

    document.getElementById('cancelCallBtn').onclick = endCall;
    document.getElementById('hangupBtn').onclick = endCall;
    
    document.getElementById('toggleAudioBtn').onclick = () => {
      if(localStream){
        isMuted = !isMuted;
        localStream.getAudioTracks()[0].enabled = !isMuted;
        document.getElementById('toggleAudioBtn').textContent = isMuted ? 'ðŸ”‡' : 'ðŸŽ¤';
        document.getElementById('toggleAudioBtn').classList.toggle('bg-red-500');
      }
    };

    // Clean up on window close
    window.addEventListener('beforeunload', () => {
      if(myUid) {
         set(ref(rdb, `presence/${myUid}`), null);
         if(currentCallNodeId) endCall();
      }
    });

  </script>
</body>
</html>
